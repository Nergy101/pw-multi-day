# Playwright Trial - Data Generation and Validation (Deno)

This project demonstrates how to use Playwright with faker-js to generate test data and share it between CI/CD pipeline runs using artifacts, powered by Deno for better TypeScript support and faster execution.

## Overview

The project consists of two main test suites that work together in a scheduled pipeline:

1. **Monday Pipeline** (`tests/generate-identifiers.spec.ts`): Generates fake person data using faker-js and saves it as artifacts
2. **Tuesday Pipeline** (`tests/validate-report.spec.ts`): Downloads the artifacts from Monday and validates the data

## Setup

### Prerequisites

- **Deno**: Install from [deno.land](https://deno.land/#installation)

### 1. Install Playwright Browsers

```bash
deno task install
```

## Test Files

### Generate Identifiers Test (`tests/generate-identifiers.spec.ts`)

This test generates fake person data using faker-js and saves it in multiple formats:

- **JSON format**: `output/person-data.json`
- **CSV format**: `output/person-data.csv`
- **Metadata**: `output/metadata.json`
- **Unique data**: `output/unique-persons.json`

**Features:**

- Generates realistic person data (names, emails, addresses, companies)
- Ensures unique IDs and emails
- Saves data in multiple formats for flexibility
- Includes metadata about the generation process
- Uses Deno APIs for better performance

**Run locally:**

```bash
deno task test:generate
```

### Validate Report Test (`tests/validate-report.spec.ts`)

This test validates the data generated by the Monday pipeline:

- Reads data from `downloaded-artifacts/` directory
- Validates data integrity and completeness
- Checks for uniqueness of IDs and emails
- Generates validation reports in JSON and human-readable formats
- Falls back to sample data if no artifacts are found

**Features:**

- Comprehensive data validation
- Uniqueness checking
- Error reporting
- Human-readable and JSON reports
- Graceful handling of missing artifacts
- Uses Deno APIs for async file operations

**Run locally:**

```bash
deno task test:validate
```

## Data Structure

The generated person data follows this structure:

```typescript
interface PersonData {
  id: string; // UUID
  firstName: string; // Generated first name
  lastName: string; // Generated last name
  email: string; // Valid email format
  phone: string; // Phone number
  address: {
    street: string; // Street address
    city: string; // City
    state: string; // State/province
    zipCode: string; // Postal code
    country: string; // Country
  };
  company: string; // Company name
  jobTitle: string; // Job title
  createdAt: string; // ISO timestamp
}
```

## CI/CD Pipeline Integration

### GitHub Actions Setup

This project is configured to run in GitHub Actions. See [GITHUB_SETUP.md](./GITHUB_SETUP.md) for detailed setup instructions.

### Monday Pipeline (Scheduled: Monday 2 AM UTC)

1. Runs `deno task test:generate`
2. Generates fake person data
3. Saves data to `output/` directory
4. Uploads `output/` as artifacts

### Tuesday Pipeline (Scheduled: Tuesday 2 AM UTC)

1. Downloads artifacts to `downloaded-artifacts/`
2. Runs `deno task test:validate`
3. Validates the downloaded data
4. Generates validation reports
5. Uploads validation results as artifacts

## Local Development

### Running Tests

```bash
# Run all tests
deno task test

# Run specific test suites
deno task test:generate
deno task test:validate

# Run with UI
deno task test:ui

# Run in headed mode
deno task test:headed
```

### Testing the Full Flow

1. **Generate data:**

   ```bash
   deno task test:generate
   ```

2. **Simulate artifact download:**

   ```bash
   mkdir -p downloaded-artifacts
   cp output/* downloaded-artifacts/
   ```

3. **Validate data:**
   ```bash
   deno task test:validate
   ```

### Sample Output

After running the generate test, you'll find:

```
output/
├── person-data.json      # Main person data
├── person-data.csv       # CSV format
├── metadata.json         # Generation metadata
└── unique-persons.json   # Unique data validation
```

After running the validate test, you'll find:

```
output/
├── validation-report.json  # Detailed validation results
└── validation-report.txt   # Human-readable report
```

## Configuration

### Deno Config (`deno.json`)

- Defines npm imports for Playwright and faker-js
- Configures TypeScript compiler options
- Sets up linting and formatting rules
- Defines tasks for running tests

### Playwright Config (`playwright.config.ts`)

- Uses Chromium browser
- Configures for CI environment with Deno environment variables
- Sets up proper retries and workers
- Configures HTML reporter

### Available Tasks

- `test`: Run all tests
- `test:generate`: Run data generation tests
- `test:validate`: Run validation tests
- `test:ui`: Run tests with Playwright UI
- `test:headed`: Run tests in headed mode
- `install`: Install Playwright browsers

## Dependencies

- **@playwright/test**: Testing framework (via npm import)
- **@faker-js/faker**: Data generation library (via npm import)
- **Deno**: Runtime with built-in TypeScript support

## Advantages of Using Deno

1. **Better TypeScript Support**: Native TypeScript support without additional configuration
2. **Faster Execution**: No need for npm install or node_modules
3. **Security**: Explicit permissions for file system and network access
4. **Modern APIs**: Uses modern async/await patterns with Deno APIs
5. **Simplified Setup**: Single configuration file handles everything

## Notes

- The validation test includes fallback sample data for local testing
- All generated data is realistic and follows proper formats
- The pipeline is designed to work in GitHub Actions with artifact sharing
- Data is validated for completeness, uniqueness, and format correctness
- Reports are generated in both machine-readable (JSON) and human-readable formats
- Uses Deno's built-in file system APIs for better performance

## Troubleshooting

### Common Issues

1. **Deno not installed**: Install from [deno.land](https://deno.land/#installation)
2. **Playwright browsers not installed**: Run `deno task install`
3. **Permission errors**: Ensure proper permissions are granted in deno.json
4. **Missing artifacts**: The validation test will create sample data for testing

### Debug Mode

Run tests with debug output:

```bash
DEBUG=pw:api deno task test:generate
```

### View Test Results

After running tests, view the HTML report:

```bash
deno run --allow-read --allow-write --allow-env --allow-run --allow-net npm:@playwright/test show-report
```

### Format and Lint Code

```bash
# Format code
deno fmt

# Lint code
deno lint
```
